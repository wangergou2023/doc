



## 同步与互斥

### spilock

### semaphore

### mutex

## 基础知识

### 一切皆文件

include\linux\fs.h

#### struct file

~~~c
struct file {
    struct path		f_path;          // 文件的路径结构
    struct inode	*f_inode;        // 与此文件关联的inode对象
    const struct file_operations	*f_op;   // 文件操作函数指针的集合

    spinlock_t		f_lock;          // 自旋锁，用于保护某些字段
    atomic_long_t		f_count;       // 文件引用计数
    unsigned int 		f_flags;       // 文件标志
    fmode_t			f_mode;        // 文件模式（例如，读、写等）
    struct mutex		f_pos_lock;    // 用于保护 f_pos 的互斥锁
    loff_t			f_pos;         // 文件的当前位置
    struct fown_struct	f_owner;      // 文件的所有者信息
    const struct cred	*f_cred;      // 文件的凭证信息
    struct file_ra_state	f_ra;       // 用于文件预读的状态

    struct address_space	*f_mapping; // 文件数据的内存映射

    void			*private_data; // 指向私有数据的指针，可能用于各种驱动程序
} __attribute__((aligned(4)));	/* 确保至少4字节对齐 */
~~~

#### struct inode

```c
struct inode {
	umode_t i_mode; // 文件模式（例如，读、写、执行等权限）
	kuid_t i_uid; // 文件的用户ID
	kgid_t i_gid; // 文件的组ID
	unsigned int i_flags; // inode标志
	const struct inode_operations *i_op; // inode操作函数指针的集合
	struct super_block *i_sb; // inode所属的超级块

	unsigned long i_ino; // inode号码
	dev_t i_rdev; // 特殊文件的设备号
	union {
		struct block_device *i_bdev;
		struct cdev *i_cdev;
		char *i_link;
	};
	loff_t i_size; // 文件大小
	spinlock_t i_lock; // 自旋锁，用于保护某些字段

	unsigned long i_state; // inode状态
	struct rw_semaphore i_rwsem; // 读写信号量

	atomic64_t i_version; // inode版本
	atomic_t i_count; // inode引用计数

	const struct file_operations *i_fop; // 默认的文件操作

	void *i_private; // 文件系统或设备的私有指针，例如与I2C, SPI, USB, USART, RMII等设备驱动程序相关的数据
} __randomize_layout;
```

#### struct file_operations

```c
struct file_operations {
	struct module *owner; // 所属模块，通常用于模块计数
	loff_t (*llseek)(struct file *, loff_t, int); // 改变文件的当前读/写位置
	ssize_t (*read)(struct file *, char __user *, size_t, loff_t *); // 从文件读取数据
	ssize_t (*write)(struct file *, const char __user *, size_t, loff_t *); // 向文件写入数据
	int (*open)(struct inode *, struct file *); // 打开文件
	int (*release)(struct inode *, struct file *); // 关闭文件
	int (*mmap)(struct file *, struct vm_area_struct *); // 创建内存映射
	long (*unlocked_ioctl)(struct file *, unsigned int, unsigned long); // 无锁IO控制
	int (*flush)(struct file *, fl_owner_t id); // 刷新文件
	int (*fsync)(struct file *, loff_t, loff_t, int datasync); // 同步文件
	__poll_t (*poll)(struct file *, struct poll_table_struct *); // 轮询文件状态
} __randomize_layout;
```

`struct file`、`struct inode` 和 `struct file_operations` 在 Linux 内核中是文件系统和设备驱动的核心结构。它们的关系如下：

1. **`struct inode`**: 
    - 这是文件系统中的一个核心结构，代表一个 inode 对象。在 UNIX 世界中，几乎所有内容都是文件（文件、目录、设备等）。每个文件在文件系统中都有一个与之关联的 inode，其中包含了该文件的元数据（例如，文件的大小、权限、创建时间、修改时间等）。
    - `struct inode` 还包含指向与特定文件系统相关的操作的指针，这些操作由文件系统实现。例如，EXT4 和 NFS 文件系统会为其 inodes 提供不同的操作集。

2. **`struct file`**: 
    - 当一个进程打开一个文件时，它会获得一个与该文件关联的 `struct file` 对象。这个结构描述了一个打开的文件实例。
    - `struct file` 中有一个 `f_op` 字段，该字段是一个指向 `struct file_operations` 的指针，其中包含了一系列与该文件相关的操作。
    - 同样，`struct file` 也有一个 `f_inode` 字段，这是一个指向 `struct inode` 的指针，表示该文件的 inode。

3. **`struct file_operations`**: 
    - 这个结构体定义了一组可以在一个打开的文件上执行的操作的函数指针。
    - 这是驱动程序和文件系统实现与内核接口的主要方式。当你在一个文件上执行一个操作（如读或写）时，内核会调用与该文件关联的 `struct file_operations` 中的相应函数。
    - 例如，当用户空间的程序调用 `read()` 系统调用时，内核会转而调用与打开的文件关联的 `struct file_operations` 中的 `read` 函数。

**关系概述**：
- 每个文件都有一个 inode（`struct inode`），它包含文件的元数据。
- 当一个文件被打开时，会创建一个文件描述符（`struct file`）来表示这个打开的文件实例。
- `struct file` 包含一个指向 `struct inode` 的指针（即文件的元数据）以及一个指向 `struct file_operations` 的指针（即可以在该文件上执行的操作）。

在实际的文件系统或设备驱动开发中，这三个结构体的实例通常会密切地协同工作，以提供期望的功能和性能。



### device设备

### driver驱动

### bus总线

### class类



## platform虚拟总线

Platform总线参考代码（内核源码）
drivers\base\platform.c
include\linux\platform_device.h

### Platform驱动

struct platform_driver {
		int (*probe)(struct platform_device *);		//平台驱动初始化时会调用该函数
		int (*remove)(struct platform_device *);	//平台驱动卸载时会调用该函数
		void (*shutdown)(struct platform_device *);	//平台驱动关闭时会调用该函数
		int (*suspend)(struct platform_device *, pm_message_t state);
		int (*resume)(struct platform_device *);	//平台驱动释放时会调用该函数
		struct device_driver driver;			//内置device_driver结构体
		const struct platform_device_id *id_table;	//该设备驱动支持的设备列表，通过该指针指向platform_device_id类型的数组
	};

* 注册函数：platform_driver_register
* 完成注册以后再 /sys/bus/platform/drivers目录下会看到 dev.name的文件

### Platform设备

struct platform_device {
	const char	*name;				//platform设备名字
	int		id;				//用于区分设备名相同时将在设备名后面追加该ID
	struct device	dev;				//内置device结构体
	u32		num_resources;			//资源结构体数量
	struct resource	*resource;			//指向资源结构体数组
	const struct platform_device_id	*id_entry;	//用来进行与设备驱动匹配用的id_table表
	struct pdev_archdata	archdata;		//私有数据，添加自己的东西
};

* 注册函数：platform_add_devices
* 完成注册以后将会在/sys/bus/platform/devices目录下会看到dev.name的文件夹

![1](.\2.png)

## GPIO子系统



## IIC子系统



## rootfs

常见的根文件系统制作工具有 buildroot、Ubuntu、Debian、yocto、busybox，这些工具的优缺点列出如下

![1](.\1.png)

